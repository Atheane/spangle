<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> CV Game - Elodie Royant</title>

  <style>

    html, body {
      width:  100%;
      height: 100%;
      margin: 0px;
    }

    * { padding: 0; margin: 0; }

    .container {
      position: relative;
    }

    #background {
      position: absolute;
      z-index: 1;
    }

    #foreground {
      position: absolute;
      z-index: 2;
    }

  </style>

  <script>

  var bg, ctxBg, canvas, ctx;
  var drawn;

  // background object
  var background = {
    src: './assets/backgrounds/background_02_parallax_01.png',
    init: function() {
            var img = new Image()
            img.src = this.src;
            return img;
          },
    draw: function() {
        ctxBg.clearRect(0, 0, bg.width, bg.height);
        // ctxBg.restore();
        var img = this.init();
        img.addEventListener('load', function() {
          // ctxBg.globalCompositeOperation = "destination-over";
          ctxBg.drawImage(img, 0, 0);
          ctxBg.save();
        });
    }
  }

  // spaceSphip object
  // It inherits from background object method init()
  var spaceShip = Object.create(background);
  spaceShip.src = './assets/spaceships/enemy-defense.png';
  spaceShip.x = window.innerWidth/2 - 100;
  spaceShip.y = window.innerHeight*0.9 - 100;
  spaceShip.width = window.innerWidth/14;
  // TODO
  spaceShip.height = spaceShip.width;
  spaceShip.dx = 5;
  spaceShip.dy = 5;
  // new draw method (resizing, no destination-over)
  spaceShip.draw = function() {
    // ctx.clearRect(0, 0, canvas.width, canvas.height);
    // restore and save before each new draw : avoid redrawing background each time
    // ctx.restore();
    var img = this.init();
    var that = this;
    img.addEventListener('load', function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // ctx.globalCompositeOperation = "source-over";
      ctx.drawImage(img, that.x, that.y, that.width, that.height);
      that.x += that.dx;
      that.y += that.dy;
    });
  };

  var start;
  var pause;

  var gameLoop = function(timestamp) {
    if (!start) { start = timestamp; }
    // if more than 150 ms since last timestamp
    if (timestamp - start >= 150) {
      start = timestamp;
      spaceShip.draw();
    }
    if (!pause) {
      window.requestAnimationFrame(gameLoop);
    }
  }

  // Events Handlers
  document.addEventListener('DOMContentLoaded', function() {
    console.log('loaded');
    bg = document.getElementById("background");
    ctxBg = bg.getContext('2d');
    bg.width  = window.innerWidth;
    bg.height = window.innerHeight;

    canvas = document.getElementById("foreground");
    ctx = canvas.getContext('2d');
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;

    background.draw();
    console.log("bcg drawn");
    gameLoop();
  });

 document.addEventListener('keydown', function() {
    pause = false;
    gameLoop(0);
  });

  document.addEventListener('keyup', function() {
    pause = true;
    gameLoop(0);
  });



  </script>
</head>

<body>

  <div id="container">
    <canvas id="background" >
      "Your browser does not support canvas :("
    </canvas>
    <canvas id="foreground">
      "Your browser does not support canvas :("
    </canvas>
    <!-- https://www.html5rocks.com/en/tutorials/canvas/performance/ -->
  </div>


</body>

</html>

