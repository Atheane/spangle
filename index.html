<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> CV Game - Elodie Royant</title>

  <style>

    html, body {
      width:  100%;
      height: 100%;
      margin: 0px;
    }

    * { padding: 0; margin: 0; }

    .container {
      position: relative;
    }

    canvas {
      position: absolute;
      top: 0px;
      left: 0px;
    }

    #background {
      z-index: -2;
    }

    #main {
      z-index: -1;
    }

    #player {
      background: transparent;
      z-index: 0;
    }

  </style>
  <script>

'use strict';




  //////////////////////////////////////////////////////////////////////////
  //                         Gestion des image                          //
  /////////////////////////////////////////////////////////////////////////

// (function() {


  var image = {
    background:  new Image(),
    player: new Image(),
    counter: 0
    // bullet = new Image()
  };

  var imageLoading = function() {
    image.player.addEventListener('load', function() {
      console.log('player loaded');
      image.counter++;
    });
    image.background.addEventListener('load', function() {
      console.log('background loaded');
      image.counter++;
    });

    // bullet.addEventListener('load', function() {
    //   counter++;
    // });
    // pour charger les images en mémoire (async)
    image.background.src = './assets/backgrounds/background_02_parallax_01.png';
    image.player.src = './assets/spaceships/EnemyDefense.png';

    while (image.counter < 2) {
      alert('loading');
    }
  }



  //////////////////////////////////////////////////////////////////
  //                  Objets dessinés sur les canvas              //
  //////////////////////////////////////////////////////////////////

  // Prototype de l'ensemble des futurs dessins
  // TO-DO : fonction usine pour minimiser l'espace mémoire ?
  var Dessin = function() {
      this.init = function(x, y, width, height) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
      }
      this.speed = 0;
      this.canvasWidth = 0;
      this.canvasHeight = 0;
  }

  // On prévoit une méthode draw (obligatoire avec canvas)
  Dessin.prototype.draw = function() {
  };

  // instance pour mettre en place la chaine de prototype
  var dessin = new Dessin;


  //////////////////////////// Premier enfant : objet background
  // Fonction constructeur background
  var Background = function() {
    this.speed = 1;
    this.totalSeconds = 0;
    this.shiftCameraX = 0;
    this.shiftCameraY = 0;
  }

  Background.prototype = dessin;

  Background.prototype.draw = function() {
    // décale le background en fonction de la vitesse indiquée
    // this.y += this.speed;

    // // la propriété context est définie dans la fonction constructeur Game
    // // this.context.drawImage(image.background, this.x, this.y);
    // this.context.drawImage(image.background, this.x, this.y - this.canvasHeight);

    // if (this.y >= this.canvasHeight) {
    //   this.y = 0;
    // }

    this.totalSeconds += this.speed;
    var vx = 0; // number pixels per sec
    var vy = 1; // number pixels per sec
    var numImagesX = Math.ceil((this.canvasWidth + Math.abs(this.shiftCameraX) + Math.abs(this.shiftCameraY)) / image.background.width) + 1;
    var numImagesY = Math.ceil((this.canvasHeight  + Math.abs(this.shiftCameraX) + Math.abs(this.shiftCameraY))/ image.background.height) + 1 ;

    var xpos = this.totalSeconds * vx % image.background.width;
    var ypos = (this.canvasHeight - this.totalSeconds * vy) % image.background.height;
    this.context.save();
    this.context.translate(-xpos, -ypos);
    for (var i = 0; i < numImagesX; i++) {
      for (var j = 0; j < numImagesY; j++) {
        this.x = i * image.background.width;
        this.y = -j * image.background.height;
        // var y = -j * img.height - spaceShip.y*0.4;
        this.context.drawImage(image.background, this.x, this.y);
       }
     }
    this.context.restore();
  };

  // pour gérer les collisions avec le bord d'écran
  // Background.prototype.move = function() {
  //   this.context.translate(-200, 0);
  //   this.shiftCameraX -= 200;
  // }

  ///////////////////////////////////////////////////////////////////
  //                      SPACE SHIP OBJECT
  ///////////////////////////////////////////////////////////////////

  // spaceSphip object
  // It inherits from background object method init()
  var Player = function() {
    this.speed = 10;
    // this.acceleration = 1.3;
    this.i = 1;
    this.j = 0;
  }

  Player.prototype = dessin;

  Player.prototype.draw = function() {
    // plus économe d'effacer juste un rectangle autour du spaceShip (possible car aux multiples overlay)
    var boundariesX = [0, 2048, 4096];
    var boundariesY = [0, 2048, 4096, 6144];

    // this.context.clearRect(0, 0, this.width, this.height);
    this.context.drawImage(image.player, boundariesX[this.i], boundariesY[this.j], image.player.width/boundariesX.length, image.player.height/boundariesY.length, this.x, this.y, this.width, this.height);
    // console.log(image.player, boundariesX[this.i], boundariesY[this.j], image.player.width/boundariesX.length, image.player.height/boundariesY.length, this.x, this.y, this.width, this.height);
    // this.context.drawImage(image.player,2048,0, 2048, 2048, window.innerWidth/2, window.innerHeight*0.9, 150,150);
   };


  // var rightPressed, leftPressed, upPressed, downPressed, mitraillettePressed, roquettePressed;


  // spaceShip.move = function() {
  //   if (leftPressed) {
  //     this.x -= this.dx;
  //     (i > 0) ? i-=1 : i=0;
  //   }
  //   else if (rightPressed) {
  //     this.x += this.dx;
  //     (i < 2) ? i+=1 : i=2;
  //   }
  //   if (upPressed) {
  //     this.y -= this.v * this.dy;
  //   }
  //   else if (downPressed) {
  //     this.y += this.dy / this.v;
  //   }
  // };

  // spaceShip.shoot = function() {
  //   if (mitraillettePressed && !roquettePressed) {
  //     j = 1;
  //   }
  //   else if (!mitraillettePressed && roquettePressed) {
  //     j = 2;
  //   }
  //   else if (mitraillettePressed && roquettePressed) {
  //     j = 3;
  //   }
  //   else {
  //     j = 0;
  //   }
  // }



  //////////////////////////////////////////////////////////////////////////
  ///                             Objet JEU                              ///
  //////////////////////////////////////////////////////////////////////////

  var Game = function() {
    this.init = function() {
      imageLoading();
      console.log(image.counter);
      this.bgCanvas = document.getElementById('background');
      this.playerCanvas = document.getElementById('player');

        // vérifier si canvas est bien supporté par le navigateur
      if (this.bgCanvas.getContext) {

        this.bgContext = this.bgCanvas.getContext('2d');
        // this.bgContext.globalCompositeOperation = 'source-over';

        this.playerContext = this.playerCanvas.getContext('2d');
        // this.playerContext.globalCompositeOperation = 'destination-over';

        this.bgCanvas.width  = window.innerWidth;
        this.bgCanvas.height = window.innerHeight;
        this.playerCanvas.width  = window.innerWidth;
        this.playerCanvas.height = window.innerHeight;
        // on ajoute les propriétés manquantes à Background
        // utilisées dans la méthode draw
        Background.prototype.context = this.bgContext;
        Background.prototype.canvasWidth = this.bgCanvas.width;
        Background.prototype.canvasHeight = this.bgCanvas.height;

        // Player.prototype.context = this.playerContext;
        // Player.prototype.canvasWidth = this.playerCanvas.width;
        // Player.prototype.canvasHeight = this.playerCanvas.height;

        this.background = new Background();
        this.background.init(0,0);

        this.player = new Player();
        var playerX = this.playerCanvas.width/2-150;
        var playerY = Math.ceil(this.playerCanvas.height*0.8);

        this.player.init(playerX, playerY, 150, 150);
        // console.log(playerX, playerY, 250, 250)
        return true;
      }
      else {
        return false;
      }
    };
    // Start the animation loop
    this.start = function() {
      gameLoop(0);
    };
  }

  var game = new Game();

  var start;

  //////////////////////////////////////////////////////////////////////////
  ///                         Animation JEU                              ///
  //////////////////////////////////////////////////////////////////////////


  var gameLoop = function(timestamp) {
    if (!start) { start = timestamp; }
    // if more than 50 ms since last timestamp
    if (timestamp - start >= 50) {
      game.background.draw();
      game.player.draw();
      start = timestamp;
      // spaceShip.draw();
      // spaceShip.move();
      // spaceShip.shoot();
    }
    // if (spaceShip.x < 20 || spaceShip.x > bg.width - spaceShip.width - 20) {
    //   // console.log("collision !");
    // }
    window.requestAnimationFrame(gameLoop);

  }


  ///////////////////////////////////////////////////////////////////
  //                      EVENTS HANDLERS
  ///////////////////////////////////////////////////////////////////

  document.addEventListener('DOMContentLoaded', function() {
    /*while (image.counter < 3) {
      console.log("loading");
    }*/
    if (game.init()) {
      game.start();
    }

  });









 // document.addEventListener('keydown', function(e) {
 //    // pause = false;
 //    if (e.keyCode === 39) {
 //      rightPressed = true;
 //    }
 //    else if(e.keyCode === 37) {
 //      leftPressed = true;
 //    }
 //    if(e.keyCode === 40) {
 //      downPressed = true;
 //    }
 //    else if(e.keyCode === 38) {
 //      upPressed = true;
 //    }
 //    if (e.keyCode === 77) {
 //      mitraillettePressed = true;
 //    }
 //    if (e.keyCode === 82) {
 //      roquettePressed = true;
 //    }
 //    gameLoop(0);

 //  });

 //  document.addEventListener('keyup', function(e) {
 //    // pause = true;
 //    if(e.keyCode === 39) {
 //      rightPressed = false;
 //      i = 1;
 //    }
 //    else if(e.keyCode === 37) {
 //      leftPressed = false;
 //      i = 1;
 //    }
 //    if(e.keyCode === 40) {
 //      downPressed = false;
 //    }
 //    else if(e.keyCode === 38) {
 //      upPressed = false;
 //    }
 //    if (e.keyCode === 77) {
 //      mitraillettePressed = false;
 //    }
 //    if (e.keyCode === 82) {
 //      roquettePressed = false;
 //    }
 //    gameLoop(0);

 //  });

// }());

  </script>
</head>

<body>

  <div id="container">
    <canvas id="background" >
      Your browser does not support canvas :(, please try with another one!
    </canvas>
    <canvas id="main">
      Your browser does not support canvas :(, please try with another one!
    </canvas>
    <canvas id="player">
      Your browser does not support canvas :(, please try with another one!
    </canvas>
    <!-- https://www.html5rocks.com/en/tutorials/canvas/performance/ -->
  </div>

</body>

</html>

