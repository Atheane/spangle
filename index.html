<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title> CV Game - Elodie Royant</title>

  <style>

/*    html, body {
      width:  100%;
      height: 100%;
      margin: 0px;
    }

    * { padding: 0; margin: 0; }

    .container {
      position: relative;
    }*/

    canvas {
      position: absolute;
      top: 0px;
      left: 0px;
      background: transparent;
    }

    #background {
      z-index: 1;
    }

    #foreground {
      z-index: 2;
    }

  </style>
  <script>

'use strict';

(function() {
  var bg, ctxBg, canvas, ctx;
  var totalSeconds = 0;

  ///////////////////////////////////////////////////////////////////
  //                      BACKGROUND OBJECT
  ///////////////////////////////////////////////////////////////////


  var background = {
    src: './assets/backgrounds/background_02_parallax_01.png',
    init: function() {
            var img = new Image();
            img.src = this.src;
            return img;
    },
    moveWithTime: function(delay) {

            var img = this.init();
            var that = this;

            img.addEventListener('load', function() {
              totalSeconds += delay;
              // console.log("totalSeconds :" + totalSeconds);

              var vy = 100; // the background scrolls with a speed of 100 pixels/sec

              var numImagesX = Math.ceil(bg.width / img.width) + 1;
              // console.log("numImagesX :" + numImagesX);
              // console.log("bg.width :" + bg.width);
              // console.log("img.width :" + img.width);

              var numImagesY = Math.ceil(bg.height / img.height) + 1;

              that.xpos =  (spaceShip.x*0.4) % img.width ;
              // console.log("xpos :" + that.xpos);

              that.ypos = (bg.height - totalSeconds * vy) % img.height;

              ctxBg.save();
              ctxBg.translate(-that.xpos, -that.ypos);

              for (var i = 0; i < numImagesX; i++) {
                for (var j = 0; j < numImagesY; j++) {
                  var x = i * img.width;
                  var y = -j * img.height - spaceShip.y*0.4;
                  ctxBg.drawImage(img, x, y);
                 }
               }
              ctxBg.restore();
            });
    },
    moveWithCollision: function() {
              // this.alpha = () ? 1.2 : 0.4;

    }
  }


  ///////////////////////////////////////////////////////////////////
  //                      SPACE SHIP OBJECT
  ///////////////////////////////////////////////////////////////////

  var i = 1;
  var j = 0;

  // spaceSphip object
  // It inherits from background object method init()
  var spaceShip = Object.create(background);
  spaceShip.src = './assets/spaceships/EnemyDefense.png';

  spaceShip.x = window.innerWidth/2 - 100;
  spaceShip.y = window.innerHeight*0.9 - 100;

  spaceShip.dx = 10;
  spaceShip.dy = 10;

  spaceShip.v = 1.3;

  spaceShip.width = 0;
  spaceShip.height = 0;

  spaceShip.boundariesX = [0, 2048, 4096];
  spaceShip.boundariesY = [0, 2048, 4096, 6144];

  // new draw method (resizing, no destination-over)
  spaceShip.draw = function() {
    // restore and save before each new draw : avoid redrawing background each time
    var img = this.init();
    var that = this;

    that.height = window.innerWidth/10;
    that.width = that.height;

    img.addEventListener('load', function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // ctxBg.globalCompositeOperation = 'source-over';
      ctx.drawImage(img, spaceShip.boundariesX[i], spaceShip.boundariesY[j], img.width/spaceShip.boundariesX.length, img.height/spaceShip.boundariesY.length, that.x, that.y, that.width, that.height);
    });
  };


  var rightPressed, leftPressed, upPressed, downPressed, mitraillettePressed, roquettePressed;


  spaceShip.move = function() {
    if (leftPressed) {
      this.x -= this.dx;
      (i > 0) ? i-=1 : i=0;
    }
    else if (rightPressed) {
      this.x += this.dx;
      (i < 2) ? i+=1 : i=2;
    }
    if (upPressed) {
      this.y -= this.v * this.dy;
    }
    else if (downPressed) {
      this.y += this.dy / this.v;
    }
  };

  spaceShip.shoot = function() {
    if (mitraillettePressed && !roquettePressed) {
      j = 1;
    }
    else if (!mitraillettePressed && roquettePressed) {
      j = 2;
    }
    else if (mitraillettePressed && roquettePressed) {
      j = 3;
    }
    else {
      j = 0;
    }
  }


///////////////////////////////////////////////////////////////////
//                            GAME LOOP
///////////////////////////////////////////////////////////////////

  var start;
  var pause;

  var gameLoop = function(timestamp) {
    if (!start) { start = timestamp; }
    // if more than 50 ms since last timestamp
    if (timestamp - start >= 5) {
      // flowing speed depends on the spaceship speed
      background.moveWithTime((timestamp - start) / 1000);
      start = timestamp;
      spaceShip.draw();
      spaceShip.move();
      spaceShip.shoot();
    }
    if (spaceShip.x < 20 || spaceShip.x > bg.width - spaceShip.width - 20) {
      console.log("collision !");
    }
    window.requestAnimationFrame(gameLoop);

  }



///////////////////////////////////////////////////////////////////
//                      EVENTS HANDLERS
///////////////////////////////////////////////////////////////////

  document.addEventListener('DOMContentLoaded', function() {

    bg = document.getElementById("background");
    ctxBg = bg.getContext('2d');
    bg.width  = window.innerWidth;
    bg.height = window.innerHeight;

    canvas = document.getElementById("foreground");
    ctx = canvas.getContext('2d');
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;

    background.moveWithCollision(bg);
    gameLoop(0);

  });

 document.addEventListener('keydown', function(e) {
    // pause = false;
    if (e.keyCode === 39) {
      rightPressed = true;
    }
    else if(e.keyCode === 37) {
      leftPressed = true;
    }
    if(e.keyCode === 40) {
      downPressed = true;
    }
    else if(e.keyCode === 38) {
      upPressed = true;
    }
    if (e.keyCode === 77) {
      mitraillettePressed = true;
    }
    if (e.keyCode === 82) {
      roquettePressed = true;
    }
    gameLoop(0);

  });

  document.addEventListener('keyup', function(e) {
    // pause = true;
    if(e.keyCode === 39) {
      rightPressed = false;
      i = 1;
    }
    else if(e.keyCode === 37) {
      leftPressed = false;
      i = 1;
    }
    if(e.keyCode === 40) {
      downPressed = false;
    }
    else if(e.keyCode === 38) {
      upPressed = false;
    }
    if (e.keyCode === 77) {
      mitraillettePressed = false;
    }
    if (e.keyCode === 82) {
      roquettePressed = false;
    }
    gameLoop(0);

  });

}());

  </script>
  <script src='./js/background.js'></script>
  <script>
    document.addEventListener('load', function(){
      game.init();
      game.start();
    });
  </script>
</head>

<body>

  <div id="container">
    <canvas id="background" >
      Your browser does not support canvas :(, please try with another one!
    </canvas>
    <canvas id="foreground">
      Your browser does not support canvas :(, please try with another one!
    </canvas>
    <!-- https://www.html5rocks.com/en/tutorials/canvas/performance/ -->
  </div>

</body>

</html>

